x-keycloak-common-env: &keycloak-common-env
  BACKEND_HTTP_BASE_PATH_ssegning-keybound-wh-01: "http://prism:4010"
  BACKEND_HTTP_AUTH_USERNAME: "admin"
  BACKEND_HTTP_AUTH_PASSWORD: "password"

  NONCE_CACHE_TTL_ssegning-keybound-wh-01: "60"

x-keycloak-common-extra: &keycloak-common-extra
  entrypoint: /bin/sh
  command:
    - -c
    - |
      set -ex
      ls -lash /tmp/libs-*/*.jar
      cp /tmp/libs-*/*.jar /opt/keycloak/providers # Copy the provider jars to the providers directory
      /opt/keycloak/bin/kc.sh start-dev --import-realm # Start Keycloak in dev mode and import the realm
  volumes:
    - ./.docker/keycloak-config/:/opt/keycloak/data/import/:ro
    - ./keycloak-keybound-api-gateway-http/build/libs:/tmp/libs-core:ro
    - ./keycloak-keybound-api-gateway-http/build/libs:/tmp/libs-api-gateway-http
    - ./keycloak-keybound-authenticator-approval/build/libs:/tmp/libs-authenticator-approval
    - ./keycloak-keybound-authenticator-enrollment/build/libs:/tmp/libs-authenticator-enrollment
    - ./keycloak-keybound-core/build/libs:/tmp/libs-core
    - ./keycloak-keybound-credentials-device-key/build/libs:/tmp/libs-credentials-device-key
    - ./keycloak-keybound-custom-endpoint/build/libs:/tmp/libs-custom-endpoint
    - ./keycloak-keybound-grant-device-key/build/libs:/tmp/libs-grant-device-key
    - ./keycloak-keybound-protocol-mapper/build/libs:/tmp/libs-protocol-mapper
    - ./keycloak-keybound-theme/build/libs:/tmp/libs-theme
  links:
    - prism

services:
  keycloak-26:
    image: quay.io/keycloak/keycloak:26.5.2
    ports:
      - '127.0.0.1:9026:9026'
    environment:
      <<: *keycloak-common-env
      KC_HTTP_PORT: 9026
    <<: *keycloak-common-extra

  prism:
    image: stoplight/prism:latest
    ports:
      - '127.0.0.1:4010:4010'
    command:
      - mock
      - -h
      - 0.0.0.0
      - /backend.open-api.yml
    volumes:
      - ./openapi/backend.open-api.yml:/backend.open-api.yml
    restart: unless-stopped
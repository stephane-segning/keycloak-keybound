x-keycloak-common-env: &keycloak-common-env
  BACKEND_HTTP_BASE_PATH_ssegning-keybound-wh-01: "http://api-mock:8080"
  BACKEND_HTTP_BASE_PATH_e2e-testing: "http://api-backend-example:18080"
  # Dev-only credentials. Do not reuse in production; wire secrets via a vault or env injection.
  BACKEND_HTTP_AUTH_USERNAME: "admin"
  BACKEND_HTTP_AUTH_PASSWORD: "password"

  NONCE_CACHE_TTL_ssegning-keybound-wh-01: "60"

  # Dev-only Keycloak bootstrap credentials. Replace for production.
  KC_BOOTSTRAP_ADMIN_USERNAME: admin
  KC_BOOTSTRAP_ADMIN_PASSWORD: password

x-keycloak-common-extra: &keycloak-common-extra
  entrypoint: /bin/sh
  command:
    - -c
    - |
      set -ex
      ls -lash /tmp/libs-*/*.jar
      cp /tmp/libs-*/*.jar /opt/keycloak/providers # Copy the provider jars to the providers directory
      /opt/keycloak/bin/kc.sh start-dev --import-realm # Start Keycloak in dev mode and import the realm
  volumes:
    - ./.docker/keycloak-config/:/opt/keycloak/data/import/:ro
    - ./keycloak-keybound-api-gateway-http/build/libs:/tmp/libs-core:ro
    - ./keycloak-keybound-api-gateway-http/build/libs:/tmp/libs-api-gateway-http
    - ./keycloak-keybound-authenticator-enrollment/build/libs:/tmp/libs-authenticator-enrollment
    - ./keycloak-keybound-core/build/libs:/tmp/libs-core
    - ./keycloak-keybound-credentials-device-key/build/libs:/tmp/libs-credentials-device-key
    - ./keycloak-keybound-custom-endpoint/build/libs:/tmp/libs-custom-endpoint
    - ./keycloak-keybound-grant-device-key/build/libs:/tmp/libs-grant-device-key
    - ./keycloak-keybound-protocol-mapper/build/libs:/tmp/libs-protocol-mapper
    - ./keycloak-keybound-theme/build/libs:/tmp/libs-theme
    - ./keycloak-keybound-user-storage-backend/build/libs:/tmp/libs-user-storage-backend
  links:
    - api-mock

services:
  keycloak-26:
    image: quay.io/keycloak/keycloak:26.5.2
    ports:
      - '127.0.0.1:9026:9026'
    environment:
      <<: *keycloak-common-env
      KC_HTTP_PORT: 9026
    <<: *keycloak-common-extra

  api-mock:
    image: wiremock/wiremock:3.13.0
    ports:
      - "127.0.0.1:8080:8080"
    command: ["--global-response-templating"]
    volumes:
      - ./.docker/wiremock:/home/wiremock

  api-backend-example:
    image: amazoncorretto:21
    ports:
      - "127.0.0.1:18080:18080"
    environment:
      LOGGING_LEVEL_ROOT: DEBUG
      LOGGING_LEVEL_COM_SSEGNING_KEYCLOAK_KEYBOUND_EXAMPLES: DEBUG
    command: ["java", "-jar", "/app/backend-spring-kotlin-example-0.1.1.jar"]
    volumes:
      - ./examples/backend-spring-kotlin/build/libs:/app:ro
